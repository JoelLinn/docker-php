From c14eb8de974fc8a4d74f3515424c293bc7a40fba Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Mon, 16 Dec 2019 01:14:38 -0800
Subject: [PATCH] Fix bug #78793

---
 ext/exif/exif.c              |  5 +++--
 ext/exif/tests/bug78793.phpt | 12 ++++++++++++
 2 files changed, 15 insertions(+), 2 deletions(-)
 create mode 100644 ext/exif/tests/bug78793.phpt

Index: php5-5.6.40+dfsg/ext/exif/exif.c
===================================================================
--- php5-5.6.40+dfsg.orig/ext/exif/exif.c	2019-12-21 11:59:50.253264044 +0100
+++ php5-5.6.40+dfsg/ext/exif/exif.c	2019-12-21 12:03:21.571807790 +0100
@@ -2833,8 +2833,10 @@
 	}
 
 	for (de=0;de<NumDirEntries;de++) {
-		if (!exif_process_IFD_TAG(ImageInfo, dir_start + 2 + 12 * de,
-								  offset_base, data_len, displacement, section_index, 0, maker_note->tag_table TSRMLS_CC)) {
+                size_t offset = 2 + 12 * de;
+                if (!exif_process_IFD_TAG(ImageInfo, dir_start + offset,
+                                                                  offset_base, data_len - offset, displacement, section_index, 0, maker_note->tag_table TSRMLS_CC)) {
+
 			return FALSE;
 		}
 	}
Index: php5-5.6.40+dfsg/ext/exif/tests/bug78793.phpt
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ php5-5.6.40+dfsg/ext/exif/tests/bug78793.phpt	2019-12-21 12:01:18.829683492 +0100
@@ -0,0 +1,12 @@
+--TEST--
+Bug #78793: Use-after-free in exif parsing under memory sanitizer
+--FILE--
+<?php
+$f = "ext/exif/tests/bug77950.tiff";
+for ($i = 0; $i < 10; $i++) {
+    @exif_read_data($f);
+}
+?>
+===DONE===
+--EXPECT--
+===DONE===
