From e73d8e2627e6e0aa91441ffa745661c6664906f1 Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Sat, 15 Feb 2020 20:52:19 -0800
Subject: [PATCH] Fix bug #79221 - Null Pointer Dereference in PHP Session
 Upload Progress

---
 ext/session/session.c           | 10 +++++----
 ext/session/tests/bug79221.phpt | 45 +++++++++++++++++++++++++++++++++++++++++
 2 files changed, 51 insertions(+), 4 deletions(-)
 create mode 100644 ext/session/tests/bug79221.phpt

Index: php5-5.6.40+dfsg/ext/session/session.c
===================================================================
--- php5-5.6.40+dfsg.orig/ext/session/session.c	2020-03-25 10:41:03.513567704 +0100
+++ php5-5.6.40+dfsg/ext/session/session.c	2020-03-26 12:54:05.862688724 +0100
@@ -2820,9 +2820,16 @@
 				if (PS(rfc1867_cleanup)) {
 					php_session_rfc1867_cleanup(progress TSRMLS_CC);
 				} else {
-					add_assoc_bool_ex(progress->data, "done", sizeof("done"), 1);
-					Z_LVAL_P(progress->post_bytes_processed) = data->post_bytes_processed;
-					php_session_rfc1867_update(progress, 1 TSRMLS_CC);
+				       /*
+					* Z_ISUNDEF is not available here, but as CVE-2020-7062 is about
+					* null pointer dereference and the given test passes, this should
+					* be fine
+					*/
+                                        if ( progress->data != NULL ) { //ORG: if (!Z_ISUNDEF(progress->data)) {
+                                                add_assoc_bool_ex(progress->data, "done", sizeof("done"), 1);
+                                                Z_LVAL_P(progress->post_bytes_processed) = data->post_bytes_processed;
+						php_session_rfc1867_update(progress, 1 TSRMLS_CC);
+                                        }
 				}
 				php_rshutdown_session_globals(TSRMLS_C);
 			}
Index: php5-5.6.40+dfsg/ext/session/tests/bug79221.phpt
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ php5-5.6.40+dfsg/ext/session/tests/bug79221.phpt	2020-03-25 10:41:03.509567532 +0100
@@ -0,0 +1,45 @@
+--TEST--
+Null Pointer Dereference in PHP Session Upload Progress
+--INI--
+error_reporting=0
+file_uploads=1
+upload_max_filesize=1024
+session.save_path=
+session.name=PHPSESSID
+session.serialize_handler=php
+session.use_strict_mode=0
+session.use_cookies=1
+session.use_only_cookies=0
+session.upload_progress.enabled=1
+session.upload_progress.cleanup=0
+session.upload_progress.prefix=upload_progress_
+session.upload_progress.name=PHP_SESSION_UPLOAD_PROGRESS
+session.upload_progress.freq=1%
+session.upload_progress.min_freq=0.000000001
+--COOKIE--
+PHPSESSID=session-upload
+--POST_RAW--
+Content-Type: multipart/form-data; boundary=---------------------------20896060251896012921717172737
+-----------------------------20896060251896012921717172737
+Content-Disposition: form-data; name="PHPSESSID"
+
+session-upload
+-----------------------------20896060251896012921717172737
+Content-Disposition: form-data; name="PHP_SESSION_UPLOAD_PROGRESS"
+
+ryat
+-----------------------------20896060251896012921717172737
+Content-Disposition: form-data; file="file"; ryat="filename"
+
+1
+-----------------------------20896060251896012921717172737--
+--FILE--
+<?php
+
+session_start();
+var_dump($_SESSION);
+session_destroy();
+
+--EXPECTF--
+array(0) {
+}
