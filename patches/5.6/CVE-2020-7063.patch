From ead40a66785aedaa393f953a0ed9224adaf040cd Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Sat, 15 Feb 2020 22:17:14 -0800
Subject: [PATCH] Fix bug #79082 - Files added to tar with
 Phar::buildFromIterator have all-access permissions

---
 ext/phar/phar_object.c                       | 11 ++++++
 ext/phar/tests/bug79082.phpt                 | 52 ++++++++++++++++++++++++++++
 ext/phar/tests/test79082/test79082-testfile  |  1 +
 ext/phar/tests/test79082/test79082-testfile2 |  1 +
 4 files changed, 65 insertions(+)
 create mode 100644 ext/phar/tests/bug79082.phpt
 create mode 100644 ext/phar/tests/test79082/test79082-testfile
 create mode 100644 ext/phar/tests/test79082/test79082-testfile2

Index: php5-5.6.40+dfsg/ext/phar/phar_object.c
===================================================================
--- php5-5.6.40+dfsg.orig/ext/phar/phar_object.c	2020-03-24 16:49:03.700036336 +0100
+++ php5-5.6.40+dfsg/ext/phar/phar_object.c	2020-03-24 16:49:03.696036161 +0100
@@ -1427,6 +1427,7 @@
 	zend_class_entry *ce = p_obj->c;
 	phar_archive_object *phar_obj = p_obj->p;
 	char *str = "[stream]";
+	php_stream_statbuf ssb;
 
 	iter->funcs->get_current_data(iter, &value TSRMLS_CC);
 
@@ -1709,6 +1710,16 @@
 		php_stream_copy_to_stream_ex(fp, p_obj->fp, PHP_STREAM_COPY_ALL, &contents_len);
 		data->internal_file->uncompressed_filesize = data->internal_file->compressed_filesize =
 			php_stream_tell(p_obj->fp) - data->internal_file->offset;
+		if (php_stream_stat(fp, &ssb) != -1) {
+			data->internal_file->flags = ssb.sb.st_mode & PHAR_ENT_PERM_MASK ;
+		} else {
+#ifndef _WIN32
+			mode_t mask;
+			mask = umask(0);
+			umask(mask);
+			data->internal_file->flags &= ~mask;
+#endif
+		}
 	}
 
 	if (close_fp) {
Index: php5-5.6.40+dfsg/ext/phar/tests/bug79082.phpt
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ php5-5.6.40+dfsg/ext/phar/tests/bug79082.phpt	2020-03-24 16:49:03.696036161 +0100
@@ -0,0 +1,52 @@
+--TEST--
+Phar: Bug #79082: Files added to tar with Phar::buildFromIterator have all-access permissions
+--SKIPIF--
+<?php 
+if (!extension_loaded("phar")) die("skip"); 
+if (defined("PHP_WINDOWS_VERSION_MAJOR")) die("skip not for Windows")
+?>
+--FILE--
+<?php
+umask(022);
+var_dump(decoct(umask()));
+chmod(__DIR__ . '/test79082/test79082-testfile', 0644);
+chmod(__DIR__ . '/test79082/test79082-testfile2', 0400);
+
+foreach([Phar::TAR => 'tar', Phar::ZIP => 'zip'] as $mode => $ext) {
+	clearstatcache();
+	$phar = new PharData(__DIR__ . '/test79082.' . $ext, null, null, $mode);
+	$phar->buildFromIterator(new \RecursiveDirectoryIterator(__DIR__ . '/test79082', \FilesystemIterator::SKIP_DOTS), __DIR__ . '/test79082');
+	$phar->extractTo(__DIR__);
+	var_dump(decoct(stat(__DIR__ . '/test79082-testfile')['mode']));
+	var_dump(decoct(stat(__DIR__ . '/test79082-testfile2')['mode']));
+	unlink(__DIR__ . '/test79082-testfile');
+	unlink(__DIR__ . '/test79082-testfile2');
+}
+foreach([Phar::TAR => 'tar', Phar::ZIP => 'zip'] as $mode => $ext) {
+	clearstatcache();
+	$phar = new PharData(__DIR__ . '/test79082-d.' . $ext, null, null, $mode);
+	$phar->buildFromDirectory(__DIR__ . '/test79082');
+	$phar->extractTo(__DIR__);
+	var_dump(decoct(stat(__DIR__ . '/test79082-testfile')['mode']));
+	var_dump(decoct(stat(__DIR__ . '/test79082-testfile2')['mode']));
+	unlink(__DIR__ . '/test79082-testfile');
+	unlink(__DIR__ . '/test79082-testfile2');
+}
+?>
+--CLEAN--
+<?
+unlink(__DIR__ . '/test79082.tar');
+unlink(__DIR__ . '/test79082.zip');
+unlink(__DIR__ . '/test79082-d.tar');
+unlink(__DIR__ . '/test79082-d.zip');
+?>
+--EXPECT--
+string(2) "22"
+string(6) "100644"
+string(6) "100400"
+string(6) "100644"
+string(6) "100400"
+string(6) "100644"
+string(6) "100400"
+string(6) "100644"
+string(6) "100400"
Index: php5-5.6.40+dfsg/ext/phar/tests/test79082/test79082-testfile
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ php5-5.6.40+dfsg/ext/phar/tests/test79082/test79082-testfile	2020-03-24 16:49:03.696036161 +0100
@@ -0,0 +1 @@
+test
Index: php5-5.6.40+dfsg/ext/phar/tests/test79082/test79082-testfile2
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ php5-5.6.40+dfsg/ext/phar/tests/test79082/test79082-testfile2	2020-03-24 16:49:03.696036161 +0100
@@ -0,0 +1 @@
+test
